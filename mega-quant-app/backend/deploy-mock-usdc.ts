/**
 * Deploy Mock USDC and Mint Tokens
 *
 * Since testnets don't have USDC liquidity, we'll create our own!
 */

import { ethers, parseUnits } from 'ethers'
import dotenv from 'dotenv'

dotenv.config()

const SEPOLIA_RPC = 'https://ethereum-sepolia-rpc.publicnode.com'
const MINT_AMOUNT = '10000'  // Mint 10,000 USDC

// Simple ERC20 contract bytecode + ABI
const MOCK_ERC20_ABI = [
  'constructor(string memory name, string memory symbol)',
  'function mint(address to, uint256 amount) external',
  'function balanceOf(address account) external view returns (uint256)',
  'function decimals() external view returns (uint8)',
  'function symbol() external view returns (string)',
  'function approve(address spender, uint256 amount) external returns (bool)'
]

// This is a minimal ERC20 with mint function
const MOCK_ERC20_BYTECODE = '0x60806040523480156200001157600080fd5b5060405162000e6338038062000e63833981810160405281019062000037919062000181565b81816003908162000049919062000458565b5080600490816200005b919062000458565b505050505062000

54f565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620000ce8262000083565b810181811067ffffffffffffffff82111715620000f057620000ef62000094565b5b80604052505050565b60006200010562000065565b9050620001138282620000c3565b919050565b600067ffffffffffffffff82111562000136576200013562000094565b5b620001418262000083565b9050602081019050919050565b60005b838110156200016e57808201518184015260208101905062000151565b838111156200017e576000848401525b50505050565b600080604083850312156200019a576200019962000074565b5b600083015167ffffffffffffffff811115620001bb57620001ba62000079565b5b620001c985828601620001f7565b925050602083015167ffffffffffffffff811115620001ed57620001ec62000079565b5b620001fb85828601620001f7565b9150509250929050565b600082601f8301126200021d576200021c6200007e565b5b81516200022f84826020860162000118565b91505092915050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200028b57607f821691505b60208210811415620002a257620002a162000243565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620003107fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620002d1565b6200031c8683620002d1565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600062000369620003636200035d8462000334565b6200033e565b62000334565b9050919050565b6000819050919050565b620003858362000348565b6200039d620003948262000370565b848454620002de565b825550505050565b600090565b620003b4620003a5565b620003c18184846200037a565b505050565b5b81811015620003e957620003dd600082620003aa565b600181019050620003c7565b5050565b601f8211156200043857620003ff81620002a8565b6200040a84620002bd565b810160208510156200041a578190505b62000432620004298562000 02bd565b830182620003c6565b50505b505050565b600082821c905092915050565b60006200045a600019846008026200043a565b1980831691505092915050565b600062000475838362000447565b9150826002028217905092915050565b620004908262000238565b67ffffffffffffffff811115620004ac57620004ab62000094565b5b620004b8825462000272565b620004c5828285620003ed565b600060209050601f831160018114620004fd5760008415620004e8578287015190505b620004f4858262000467565b86555062000564565b601f1984166200050d86620002a8565b60005b82811015620005375784890151825560018201915060208501945060208101905062000510565b8683101562000557578489015162000553601f89168262000447565b8355505b6001600288020188555050505b505050505050565b610b04806200057c6000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c806340c10f191161005b57806340c10f191461013457806370a082311461015057806395d89b4114610180578063dd62ed3e1461019e57610088565b806306fdde031461008d578063095ea7b3146100ab57806318160ddd146100db57806323b872dd146100f9575b600080fd5b6100956101ce565b6040516100a29190610750565b60405180910390f35b6100c560048036038101906100c091906107fb565b610260565b6040516100d29190610856565b60405180910390f35b6100e3610352565b6040516100f09190610880565b60405180910390f35b610113600480360381019061010e919061089b565b61035c565b6040516101209190610856565b60405180910390f35b61014e600480360381019061014991906107fb565b61050c565b005b61016a600480360381019061016591906108ee565b61051a565b6040516101779190610880565b60405180910390f35b610188610562565b6040516101959190610750565b60405180910390f35b6101b860048036038101906101b3919061091b565b6105f4565b6040516101c59190610880565b60405180910390f35b6060600380546101dd9061098a565b80601f01602080910402602001604051908101604052809291908181526020018280546102099061098a565b80156102565780601f1061022b57610100808354040283529160200191610256565b820191906000526020600020905b81548152906001019060200180831161023957829003601f168201915b5050505050905090565b600081600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516103409190610880565b60405180910390a36001905092915050565b6000600254905090565b600081600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546103e891906109ea565b600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546104b291906109ea565b6000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506001905092915050565b6105168282610619565b5050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6060600480546105719061098a565b80601f016020809104026020016040519081016040528092919081815260200182805461059d9061098a565b80156105ea5780601f106105bf576101008083540402835291602001916105ea565b820191906000526020600020905b8154815290600101906020018083116105cd57829003601f168201915b5050505050905090565b6001602052816000526040600020602052806000526040600020600091509150505481565b80600260008282546106  2b9190610a1e565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461067f9190610a1e565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516106e49190610880565b60405180910390a35050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561072a57808201518184015260208101905061070f565b83811115610739576000848401525b50505050565b600061074a826106f0565b61075481856106fb565b93506107648185602086016107  0c565b61076d81610a74565b840191505092915050565b6000602082019050818103600083015261079281846107 3f565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006107ca8261079f565b9050919050565b6107da816107bf565b81146107e557600080fd5b50565b6000813590506107f7816107d1565b92915050565b6000819050919050565b610810816107fd565b811461081b57600080fd5b50565b60008135905061082d81610807565b92915050565b6000806040838503121561084a5761084961079a565b5b6000610858858286016107e8565b92505060206108698582860161081e565b9150509250929050565b61087c816107fd565b82525050565b60006020820190506108976000830184610873565b92915050565b6000806000606084860312156108b6576108b561079a565b5b60006108c4868287016107e8565b93505060206108d5868287016107e8565b92505060406108e68682870161081e565b9150509250925092565b6000602082840312156109065761090561079a565b5b6000610914848285016107e8565b91505092915050565b600080604083850312156109345761093361079a565b5b6000610942858286016107e8565b9250506020610953858286016107e8565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806109a257607f821691505b602082108114156109b6576109b561095d565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006109f5826107fd565b9150610a00836107fd565b925082821015610a1357610a126109bc565b5b828203905092915050565b6000610a29826107fd565b9150610a34836107fd565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610a6957610a686109bc565b5b828201905092915050565b6000601f19601f8301169050919050565b fea264697066735822122005fddcb2e7a4e4e4d4f4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e4e64736f6c634300080b0033'

async function deployMockUSDC() {
  console.log('‚ïê'.repeat(70))
  console.log('ü™ô DEPLOYING MOCK USDC ON SEPOLIA')
  console.log('‚ïê'.repeat(70))
  console.log('')

  const privateKey = process.env.TEST_PRIVATE_KEY || process.env.PRIVATE_KEY
  if (!privateKey) {
    console.error('‚ùå Please set TEST_PRIVATE_KEY')
    process.exit(1)
  }

  console.log('üì° Connecting to Sepolia...')
  const provider = new ethers.JsonRpcProvider(SEPOLIA_RPC)
  const wallet = new ethers.Wallet(privateKey, provider)
  console.log(`‚úÖ Wallet: ${wallet.address}`)
  console.log('')

  console.log('üöÄ Deploying MockUSDC contract...')
  console.log('   This will be a standard ERC20 with mint function')
  console.log('')

  try {
    // Create contract factory
    const MockERC20 = new ethers.ContractFactory(
      MOCK_ERC20_ABI,
      MOCK_ERC20_BYTECODE,
      wallet
    )

    // Deploy
    console.log('   Deploying contract...')
    const mockUSDC = await MockERC20.deploy('Mock USDC', 'USDC', {
      gasLimit: 2000000
    })

    console.log(`   TX: ${mockUSDC.deploymentTransaction()?.hash}`)
    console.log('   Waiting for confirmation...')

    await mockUSDC.waitForDeployment()
    const address = await mockUSDC.getAddress()

    console.log('')
    console.log('‚úÖ MockUSDC Deployed!')
    console.log(`   Address: ${address}`)
    console.log('')

    // Mint tokens
    console.log(`ü™ô Minting ${MINT_AMOUNT} USDC to your wallet...`)
    const mintAmount = parseUnits(MINT_AMOUNT, 6)
    const mintTx = await mockUSDC.mint(wallet.address, mintAmount)

    await mintTx.wait()

    const balance = await mockUSDC.balanceOf(wallet.address)
    console.log(`‚úÖ Minted! Balance: ${ethers.formatUnits(balance, 6)} USDC`)
    console.log('')

    console.log('‚ïê'.repeat(70))
    console.log('üéâ SUCCESS!')
    console.log('‚ïê'.repeat(70))
    console.log('')
    console.log(`Mock USDC Address: ${address}`)
    console.log(`Your Balance: ${ethers.formatUnits(balance, 6)} USDC`)
    console.log('')
    console.log('‚ö†Ô∏è  IMPORTANT: Update your token configuration!')
    console.log('')
    console.log('Edit: backend/src/lib/trading/config/tokens.ts')
    console.log(`Change USDC address for Sepolia to: ${address}`)
    console.log('')
    console.log('Then run: npx tsx add-v4-liquidity-complete.ts')
    console.log('')

  } catch (error: any) {
    console.error('‚ùå Deployment failed:', error.message)
    process.exit(1)
  }
}

deployMockUSDC().catch(console.error)
